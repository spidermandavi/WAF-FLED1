<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WAF-FLED! Leaderboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>ðŸ§‡ WAF-FLED!</h1>
    <nav>
      <a href="index.html">Leaderboard</a>
      <a href="results.html">Tournaments</a>
      <a href="achievements.html">Achievements</a>
    </nav>
  </header>

  <main>
    <h2>Current Standings</h2>
    <table id="leaderboard">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Score</th>
          <th>ðŸ§‡</th>
          <th>ðŸ’¥</th>
          <th>Î”</th>
          <th>Best Rank</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

<script>
/* ================= CONFIG ================= */

const tournamentIDs = [
  "ZLfbxNcu"
];

/* ================= SCORING ================= */

function getWafFledPoints(result, berserked, opponentBerserked) {
  switch (result) {
    case "win": return berserked ? 1.5 : 1;
    case "loss": return -1;
    case "draw": return 0;

    case "flag_win":
      return berserked ? 3 : 2;

    case "flag_loss":
      return opponentBerserked ? -3 : -2;

    case "resigned_win":
      return berserked ? 1.5 : 1;

    case "resigned_loss":
      return -1;

    default:
      return 0;
  }
}

/* ================= PGN PARSER ================= */

function classifyResult(isWinner, termination) {
  if (!isWinner) {
    if (termination.includes("Time forfeit")) return "flag_loss";
    if (termination.includes("Resignation")) return "resigned_loss";
    if (termination.includes("Abandoned") || termination.includes("Normal")) return "loss";
    return "draw";
  }

  if (termination.includes("Time forfeit")) return "flag_win";
  if (termination.includes("Resignation")) return "resigned_win";
  if (termination.includes("Abandoned") || termination.includes("Normal")) return "win";
  return "draw";
}

function parseGamePGN(pgn) {
  const result = /\[Result "([^"]+)"]/.exec(pgn)?.[1];
  const termination = /\[Termination "([^"]+)"]/.exec(pgn)?.[1] || "";

  const white = /\[White "([^"]+)"]/.exec(pgn)?.[1];
  const black = /\[Black "([^"]+)"]/.exec(pgn)?.[1];

  const whiteBerserk = /\[WhiteBerserk "1"]/.test(pgn);
  const blackBerserk = /\[BlackBerserk "1"]/.test(pgn);

  let winner = "";
  if (result === "1-0") winner = white;
  if (result === "0-1") winner = black;

  return [
    {
      player: white,
      result: classifyResult(winner === white, termination),
      berserked: whiteBerserk,
      opponentBerserked: blackBerserk
    },
    {
      player: black,
      result: classifyResult(winner === black, termination),
      berserked: blackBerserk,
      opponentBerserked: whiteBerserk
    }
  ];
}

/* ================= FETCH ================= */

async function fetchTournamentGames(id) {
  const res = await fetch(`https://lichess.org/api/tournament/${id}/games`);
  if (!res.ok) return [];

  const text = await res.text();
  if (!text) return [];

  const games = text.split(/\n(?=\[Event )/);
  return games.flatMap(parseGamePGN);
}

/* ================= LEADERBOARD ================= */

function calculateLeaderboard(games) {
  const players = {};

  games.forEach(g => {
    if (!players[g.player]) {
      players[g.player] = {
        score: 0,
        waffles: 0,
        waffled: 0,
        bestRank: Infinity
      };
    }

    players[g.player].score += getWafFledPoints(
      g.result,
      g.berserked,
      g.opponentBerserked
    );

    if (g.result === "flag_win") players[g.player].waffles++;
    if (g.result === "flag_loss") players[g.player].waffled++;
  });

  const list = Object.entries(players).map(([name, p]) => ({
    name,
    ...p
  }));

  list.sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    if (b.waffles !== a.waffles) return b.waffles - a.waffles;
    return a.waffled - b.waffled;
  });

  list.forEach((p, i) => {
    p.rank = i + 1;
    p.bestRank = Math.min(p.bestRank, p.rank);
  });

  return list;
}

/* ================= RENDER ================= */

function renderLeaderboard(list) {
  const tbody = document.querySelector("#leaderboard tbody");
  tbody.innerHTML = "";

  list.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.rank}</td>
      <td>${p.name}</td>
      <td>${p.score}</td>
      <td>${p.waffles}</td>
      <td>${p.waffled}</td>
      <td></td>
      <td>${p.bestRank}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ================= MAIN ================= */

async function updateLeaderboard() {
  let allGames = [];

  for (const id of tournamentIDs) {
    const games = await fetchTournamentGames(id);
    allGames = allGames.concat(games);
  }

  const leaderboard = calculateLeaderboard(allGames);
  renderLeaderboard(leaderboard);
}

updateLeaderboard();
</script>

</body>
</html>
