<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WAF-FLED Leaderboard</title>
<style>
  table { border-collapse: collapse; width: 80%; margin: 20px auto; }
  th, td { border: 1px solid #333; padding: 8px; text-align: center; }
  th { background-color: #1E90FF; color: white; }
</style>
</head>
<body>

<h2 style="text-align:center;">WAF-FLED Leaderboard</h2>
<table id="leaderboard">
  <thead>
    <tr>
      <th>Rank</th>
      <th>Player</th>
      <th>Score</th>
      <th>WAFFLES</th>
      <th>WAFFLED</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ---------------- CONFIG ----------------
const tournamentIDs = [
  "ZLfbxNcu", // current tournament
  // Add new tournament IDs here for future updates
];

// ---------------- WAF-FLED Scoring ----------------
function getWafFledPoints(result, berserked, termination) {
  switch(result) {
    case "win": return berserked ? 1.5 : 1;
    case "loss": return -1;
    case "draw": return 0;
    case "flag_win": return berserked ? 3 : 2;
    case "flag_loss": return termination === "Time forfeit" ? -3 : -2;
    case "resigned_win": return berserked ? 1.5 : 1;
    case "resigned_loss": return -1;
    default: return 0;
  }
}

// ---------------- REFINED PGN PARSER ----------------
function parseGamePGN(pgn) {
  const resultTag = /\[Result "([^\]]+)"]/i.exec(pgn);
  const terminationTag = /\[Termination "([^\]]+)"]/i.exec(pgn);
  const whiteBerserk = /\[WhiteBerserk "1"]/i.test(pgn);
  const blackBerserk = /\[BlackBerserk "1"]/i.test(pgn);
  const whiteTag = /\[White "([^\]]+)"]/i.exec(pgn);
  const blackTag = /\[Black "([^\]]+)"]/i.exec(pgn);

  const white = whiteTag ? whiteTag[1] : "";
  const black = blackTag ? blackTag[1] : "";
  const termination = terminationTag ? terminationTag[1] : "";

  // Determine winner
  let winner = "";
  if(resultTag) {
    const r = resultTag[1];
    if(r === "1-0") winner = white;
    else if(r === "0-1") winner = black;
    else winner = ""; // draw
  }

  // Helper to classify result
  function classifyResult(player, isWinner, isBerserked) {
    if(!isWinner) return "draw"; // default for draw
    if(termination.includes("Time forfeit")) return isWinner ? "flag_win" : "flag_loss";
    if(termination.includes("Resignation")) return isWinner ? "resigned_win" : "resigned_loss";
    if(termination.includes("Abandoned") || termination.includes("Normal")) return isWinner ? "win" : "loss";
    return "draw"; // fallback
  }

  const whiteResult = classifyResult(white, winner === white, whiteBerserk);
  const blackResult = classifyResult(black, winner === black, blackBerserk);

  return [
    { player: white, result: whiteResult, berserked: whiteBerserk, termination },
    { player: black, result: blackResult, berserked: blackBerserk, termination }
  ];
}

// ---------------- FETCH TOURNAMENT GAMES ----------------
async function fetchTournamentGames(tournamentID) {
  const url = `https://lichess.org/api/tournament/${tournamentID}/games`;
  const response = await fetch(url);
  const pgnText = await response.text();
  const games = pgnText.split(/\n(?=\[Event ")/).filter(g => g.trim() !== "");
  return games.flatMap(parseGamePGN);
}

// ---------------- CALCULATE LEADERBOARD ----------------
function calculateLeaderboard(games) {
  const players = {};

  games.forEach(g => {
    if(!players[g.player]) players[g.player] = { score:0, waffles:0, waffled:0 };
    players[g.player].score += getWafFledPoints(g.result, g.berserked, g.termination);
    if(g.result === "flag_win") players[g.player].waffles +=1;
    if(g.result === "flag_loss") players[g.player].waffled +=1;
  });

  const leaderboard = Object.keys(players).map(p => ({
    player: p,
    score: players[p].score,
    waffles: players[p].waffles,
    waffled: players[p].waffled
  }));

  leaderboard.sort((a,b) => {
    if(b.score !== a.score) return b.score - a.score;       // higher score first
    if(b.waffles !== a.waffles) return b.waffles - a.waffles; // more waffles
    return a.waffled - b.waffled;                           // fewer waffled
  });

  leaderboard.forEach((p,i) => p.rank = i+1);
  return leaderboard;
}

// ---------------- RENDER HTML ----------------
function renderLeaderboard(leaderboard) {
  const tbody = document.querySelector("#leaderboard tbody");
  tbody.innerHTML = "";
  leaderboard.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${p.rank}</td><td>${p.player}</td><td>${p.score}</td><td>${p.waffles}</td><td>${p.waffled}</td>`;
    tbody.appendChild(tr);
  });
}

// ---------------- MAIN ----------------
async function updateLeaderboard() {
  let allGames = [];
  for(const id of tournamentIDs) {
    const games = await fetchTournamentGames(id);
    allGames = allGames.concat(games);
  }
  const leaderboard = calculateLeaderboard(allGames);
  renderLeaderboard(leaderboard);
}

// Load on page
updateLeaderboard();

</script>
</body>
</html>
